import sys
import time
import signal
import logging
from datetime import datetime

from pytz import timezone, utc
from apscheduler.schedulers.background import BackgroundScheduler
from apscheduler.triggers.cron import CronTrigger
from apscheduler.executors.pool import ThreadPoolExecutor

from storage import (
    fetch_and_store_chart_data,
    fetch_and_store_youtube_data,
    fetch_and_store_holiday_data,
    save_daily_data,
)
from redis_client import redis_client

logging.basicConfig(level=logging.INFO, format="%(asctime)s %(levelname)s %(message)s")
log = logging.getLogger(__name__)
SEOUL = timezone("Asia/Seoul")


# Redis í´ë¼ì´ì–¸íŠ¸ ì´ë¦„(ìš´ì˜ íŠ¸ë ˆì´ì‹± í¸ì˜)
try:
    redis_client.client_setname("svc:main")
    log.info("Redis client name set to 'svc:main'")
except Exception:
    log.warning("client_setname failed", exc_info=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ê¸°ì¡´ ì €ì¥ ë£¨í‹´
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def scheduled_store(run_all: bool = False):
    """ê¸°ì¡´ì— ëŒë¦¬ë˜ ì €ì¥ ì‘ì—…ë“¤."""
    try:
        now = datetime.now(SEOUL)

        # ìœ íŠœë¸Œ: 11~15ì‹œ
        if run_all or (11 <= now.hour < 22):
            log.info("â° YouTube ë°ì´í„° ì €ì¥ (%s)", now.strftime("%Y-%m-%d %H:%M"))
            youtube_result = fetch_and_store_youtube_data()
            log.info(str(youtube_result))
        else:
            log.info("â­ï¸ YouTube ì €ì¥ ì‹œê°„ëŒ€ ì•„ë‹˜ (run_all=False)")

        log.info("ğŸ“ˆ chart data ì €ì¥ ì‹œì‘...")
        stored_result = fetch_and_store_chart_data()
        log.info(stored_result)

        # íœ´ì¼: ì›”ìš”ì¼
        if run_all or now.weekday() == 0:
            log.info("ğŸ“… íœ´ì¼ ë°ì´í„° ì €ì¥ ì²´í¬...")
            try:
                timestamp_b = redis_client.hget("market_holidays", "all_holidays_timestamp")
                if timestamp_b:
                    timestamp_str = timestamp_b.decode() if isinstance(timestamp_b, (bytes, bytearray)) else str(timestamp_b)
                    ts_utc = datetime.strptime(timestamp_str, "%Y-%m-%dT%H:%M:%SZ").replace(tzinfo=utc)
                    ts_kst = ts_utc.astimezone(SEOUL)
                    if ts_kst.date() == now.date():
                        log.info("â­ï¸ ì˜¤ëŠ˜ ì´ë¯¸ íœ´ì¼ ë°ì´í„° ì €ì¥ë¨. ìƒëµ")
                    else:
                        holiday_result = fetch_and_store_holiday_data()
                        log.info(str(holiday_result))
                else:
                    holiday_result = fetch_and_store_holiday_data()
                    log.info(str(holiday_result))
            except Exception as e:
                log.exception("âŒ íœ´ì¼ timestamp í™•ì¸ ì¤‘ ì˜¤ë¥˜: %s", e)
        else:
            log.info("â­ï¸ íœ´ì¼ ë°ì´í„° ìš”ì¼ ì•„ë‹˜ (run_all=False)")

        # ë°ì¼ë¦¬: 23ì‹œ ì´í›„
        if run_all or (now.hour > 22):
            log.info("ğŸ•š ë°ì¼ë¦¬ ë°ì´í„° ì €ì¥ ì‹¤í–‰")
            save_daily_data()
        else:
            log.info("â­ï¸ ë°ì¼ë¦¬ ì €ì¥ ì‹œê°„ëŒ€ ì•„ë‹˜ (run_all=False)")

    except Exception as e:
        log.exception("âŒ scheduled_store ì‹¤í–‰ ì¤‘ ì˜ˆì™¸: %s", e)



def startup_runs():
    now = datetime.now(SEOUL)
    scheduled_daily_min = 9 * 60 + 1  # 09:01 KST
    cur_min = now.hour * 60 + now.minute
    run_daily_now = abs(cur_min - scheduled_daily_min) > 5  # Â±5ë¶„ ì´ë‚´ë©´ ìŠ¤í‚µ

    log.info("ğŸš€ Startup run: scheduled_store(run_all=True) + FULL kline initialize (closed-only)")
    try:
        scheduled_store(run_all=True)
        if run_daily_now:
            log.info("ğŸ”„ Startup full-initialized 1D snapshot")
        else:
            log.info("â­ï¸ Startupì—ì„œ 1D full init ìŠ¤í‚µ(ìŠ¤ì¼€ì¤„ ì„ë°•/ì§í›„)")
    except Exception:
        log.exception("âŒ Startup run ì‹¤íŒ¨")


def main():
    executors = {"default": ThreadPoolExecutor(5)}
    job_defaults = {"coalesce": True, "max_instances": 1, "misfire_grace_time": 300}
    scheduler = BackgroundScheduler(timezone=SEOUL, executors=executors, job_defaults=job_defaults)

    scheduler.add_job(
        scheduled_store,
        CronTrigger(minute="0", timezone=SEOUL),
        id="scheduled_store",
        replace_existing=True,
    )

    startup_runs()

    scheduler.start()
    log.info("âœ… Scheduler started. (Asia/Seoul)")

    def shutdown(*_):
        log.info("ğŸ›‘ Shutting down scheduler...")
        try:
            scheduler.shutdown(wait=False)
        finally:
            sys.exit(0)

    signal.signal(signal.SIGINT, shutdown)
    signal.signal(signal.SIGTERM, shutdown)

    try:
        while True:
            time.sleep(3600)
    except KeyboardInterrupt:
        shutdown()

if __name__ == "__main__":
    main()